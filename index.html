<script>
/* =========================
   1. GLOBAL STATE
========================= */
let map, routingControl;
let allRows = [];
let markers = [];
let searchIndex = [];
let userLatLng = null;
let userMarker = null;

const uiBar = document.getElementById("uiBar");
const toggleBtn = document.getElementById("toggleBtn");
const upload = document.getElementById("upload");
const statusText = document.getElementById("statusText");
const searchInput = document.getElementById("searchInput");
const zoomBtn = document.getElementById("zoomBtn");
const downloadBtn = document.getElementById("downloadBtn");

let minimized = false;

/* =========================
   2. INIT MAP
========================= */
map = L.map("map").setView([-6.2, 106.8], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* =========================
   3. UI CONTROLS
========================= */
toggleBtn.onclick = () => {
  minimized = !minimized;
  uiBar.classList.toggle("minimized");
  toggleBtn.innerText = minimized ? "âž•" : "âž–";
};

/* =========================
   4. EXCEL LOADER
========================= */
upload.onchange = e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    allRows = XLSX.utils.sheet_to_json(sheet);

    localStorage.setItem("oyon_saved_rows", JSON.stringify(allRows));

    buildMarkers();
    statusText.innerText = "âœ… Peta berhasil dibuat";
    zoomBtn.style.display = "block";
  };
  reader.readAsArrayBuffer(e.target.files[0]);
};

/* =========================
   5. MARKER ENGINE
========================= */
function buildMarkers() {
  markers.forEach(m => map.removeLayer(m.marker));
  markers = [];
  searchIndex = [];

  allRows.forEach(row => {
    const lat = parseFloat(row.LAT);
    const lng = parseFloat(row.LON);
    if (!lat || !lng) return;

    const color = getColor(row["HARI BACA ACMT"]);
    const icon = L.divIcon({
      html: `<div class="custom-marker" style="background:${color}"></div>`,
      iconSize: [36,36],
      iconAnchor: [18,36]
    });

    const marker = L.marker([lat, lng], { icon }).addTo(map);

    marker.on("click", () => openDetail(row));

    marker.bindPopup(popupTemplate(row, lat, lng));

    markers.push({ marker, row });

    searchIndex.push({
      idpel: String(row.IDPEL || "").replace(/\D/g,""),
      meter: String(row["NOMOR METER"] || "").replace(/\D/g,""),
      marker
    });
  });
}

/* =========================
   6. POPUP TEMPLATE
========================= */
function popupTemplate(r, lat, lng) {
  return `
  <div class="popup-card">
    <div class="popup-title">ðŸ‘¤ ${r.NAMA}</div>
    <div>ðŸ“Ÿ IDPEL: ${r.IDPEL}</div>
    <div>âš¡ DAYA: ${r.DAYA}</div>
    <div>ðŸ”§ MERK: ${r["MERK METER"]}</div>
    <div>ðŸ”¢ NOMOR: ${r["NOMOR METER"]}</div>
    <div>ðŸ“… HARI BACA: ${r["HARI BACA ACMT"]}</div>
    <div class="popup-actions">
      <button class="btn-go" onclick="goToCustomer(${lat},${lng})">ðŸ§­ Datangi</button>
      <button class="btn-done" onclick="markDone('${r.IDPEL}')">âœ… Selesai</button>
    </div>
  </div>`;
}

/* =========================
   7. SEARCH ENGINE
========================= */
document.getElementById("searchBtn").onclick = () => {
  const key = searchInput.value.trim();
  if (key.length < 4) return alert("Minimal 4 digit");

  const found = searchIndex.find(o =>
    o.idpel.endsWith(key) || o.meter.endsWith(key)
  );

  if (!found) return alert("Tidak ditemukan");

  map.setView(found.marker.getLatLng(), 19);
  found.marker.openPopup();

  uiBar.classList.add("minimized");
  toggleBtn.innerText = "âž•";
};

/* =========================
   8. ROUTING
========================= */
function goToCustomer(lat, lng) {
  if (!userLatLng) return alert("GPS belum aktif");

  if (routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLatLng),
      L.latLng(lat, lng)
    ],
    addWaypoints: false,
    draggableWaypoints: false
  }).addTo(map);

  document.getElementById("cancelRouteBtn").style.display = "block";
}

function cancelRoute() {
  if (routingControl) map.removeControl(routingControl);
  routingControl = null;
  document.getElementById("cancelRouteBtn").style.display = "none";
}

/* =========================
   9. GPS USER
========================= */
const officerIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/9131/9131529.png",
  iconSize: [40,40],
  iconAnchor: [20,40]
});

navigator.geolocation?.watchPosition(pos => {
  userLatLng = [pos.coords.latitude, pos.coords.longitude];

  if (!userMarker) {
    userMarker = L.marker(userLatLng, { icon: officerIcon })
      .addTo(map)
      .bindPopup("ðŸ‘® Lokasi Anda");
  } else {
    userMarker.setLatLng(userLatLng);
  }
});

/* =========================
   10. UTILITIES
========================= */
function getColor(v) {
  const c = {A:"#e6194b",B:"#3cb44b",C:"#ffe119",D:"#4363d8"};
  return c[(v||"").toUpperCase()] || "#999";
}

function openDetail(row) {
  document.getElementById("detailPanel").classList.add("open");
  document.getElementById("detailContent").innerHTML = `
    <h3>${row.NAMA}</h3>
    <p>IDPEL: ${row.IDPEL}</p>
    <p>DAYA: ${row.DAYA}</p>
    <p>MERK: ${row["MERK METER"]}</p>
    <p>NOMOR: ${row["NOMOR METER"]}</p>
    <p>HARI BACA: ${row["HARI BACA ACMT"]}</p>`;
}
</script>
