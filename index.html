<!DOCTYPE html>
<html>
<head>
  <title>OyonID Map</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
    }

    #upload {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: none;
    }
  
    .ui-input {
      padding: 14px;
      font-size: 17px;
      border-radius: 12px;
      border: 1px solid #ccc;
    }

    .small-input {
      padding: 6px 8px;
      font-size: 13px;
    }

    .small-btn {
      padding: 6px 10px;
      font-size: 13px;
    }


    .ui-btn {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 6px;

      background: #1e293b;
      color: white;
      border: none;
      border-radius: 0;

      font-size: 14px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
    }


    .ui-secondary {
      background: #059669;
    }

    .ui-btn:hover {
      opacity: 0.9;
    }

          /* === UI BAR COMPACT === */
    .ui-bar {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 240px;          /* üî• lebih ramping */
      background: #ffffffee;
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      z-index: 9999;
    }

      .status {
      font-weight: bold;
    }

        .ui-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

      #toggleBtn {
      background: black;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 16px;
      cursor: pointer;
    }
        #cancelRouteBtn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 22px;
      font-size: 16px;
      border-radius: 30px;
      background: #dc2626;
      color: white;
      font-weight: bold;
      border: none;
      z-index: 9999;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    

    .ui-bar.minimized {
      height: auto;
    }

    .ui-bar.minimized #uiContent {
      display: none;
    }

   /* === FLOATING CONTROL GROUP (POJOK KANAN ATAS) === */
    #floatingControls {
      position: fixed;
      top: env(safe-area-inset-top, 12px);
      right: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10000;
    }

    /* Geser ke bawah supaya tidak nutup tombol cari */
    @media (max-width: 768px) {
      #floatingControls {
        top: 35px;   /* ‚¨ÖÔ∏è aman dari search / menu mobile */
      }
    }

    /* === TOMBOL FLOATING === */
    /* === TOMBOL FLOATING KOTAK LURUS === */
    .float-btn {
      min-width: 110px;
      height: 38px;

      padding: 0 10px;
      border-radius: 0;          /* ‚¨ÖÔ∏è TANPA SUDUT */
      border: none;

      background: #0f172a;
      color: #fff;

      font-size: 13px;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;       /* ‚¨ÖÔ∏è teks tidak turun */
      overflow: hidden;          /* ‚¨ÖÔ∏è cegah keluar tombol */
      text-overflow: ellipsis;

      cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.3);
    }

      #historyPanel {
      position: fixed;
      top: 120px;              /* jangan 0, biar tidak nutup header */
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 420px;

      max-height: 60vh;       /* üî• INI KUNCI */
      overflow-y: auto;       /* üî• scroll ke dalam */

      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      z-index: 9999;
    }

    @media (max-width: 768px) {
      #historyPanel {
        top: 140px;           /* ‚¨ÖÔ∏è aman di HP kecil */
      }
    }


      #map {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #111827;
      color: #fff;
      padding: 16px 22px;
      border-radius: 16px;
      font-size: 15px;
      max-width: 90%;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s ease;
      z-index: 99999;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }

      .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    #searchBtn {
        width: 64px;        /* ‚¨ÖÔ∏è kunci lebar */
        padding: 6px 0;
        flex-shrink: 0;
        text-align: center;
      }

      #searchInput {
        flex: 1;
        min-width: 0;
      }

        /* === Modern Marker Teardrop === */
      .custom-marker {
      width: 22px;
      height: 22px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 1.5px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
      position: relative;
    }

    .custom-marker::after {
      content: "";
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 7px;
      left: 7px;
    }

    .custom-marker.black {
      background: #000;
    }

    .popup-card {
      font-size: 14px;
      line-height: 1.5;
      min-width: 220px;
    }

    .popup-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .popup-row {
      margin-bottom: 2px;
    }

    .popup-actions {
      margin-top: 10px;
      display: flex;
      gap: 6px;
    }

    .btn-go {
      flex: 1;
      background: #2dd4bf;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 10px;
    }

    .btn-done {
      flex: 1;
      background: #fb7185;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 10px;
    }

    .detail-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 26vh;
      background: white;
      z-index: 9999;
      transform: translateY(100%);
      transition: 0.3s ease;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -10px 25px rgba(0,0,0,0.2);
      padding: 16px;
      overflow-y: auto;
      }
      #detailSplit {
      flex-direction: row;
    }

        /* === CARD TAHUN LALU (HITAM) === */
    .card-th {
      background: #111827;          /* hitam elegan */
      color: #f9fafb;               /* teks terang */
      border-radius: 12px;
      padding: 12px;
    }

    .card-th h3 {
      color: #fff;
    }

    .card-th .btn-go {
      background: #374151;          /* abu gelap */
    }

    .card-th .btn-done {
      background: #dc2626;          /* merah tetap kontras */
    }


    @media (max-width: 600px) {
      #detailSplit {
        flex-direction: column;
      }
    }

    .detail-panel.open {
      transform: translateY(0);
    }


    .leaflet-routing-container {
      display: none !important;
    }

    #sidebar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 22vh;   /* sebelumnya kemungkinan 60‚Äì80vh */
    background: #fff;
    border-top: 1px solid #ddd;
    border-radius: 16px 16px 0 0;
    overflow-y: auto;
    transition: transform 0.3s ease;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
    font-size: 14px;
    }

    #sidebar {
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.95);
    }

    #searchInput {
      flex: 1;
      min-width: 0;              /* ‚¨ÖÔ∏è FIX FLEX OVERFLOW HP */
    }

    #searchBtn {
      flex-shrink: 0;
    }

    .highlight-marker {
    animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }

    .marker-label {
      background: transparent;
      border: none;
      color: #111;
      font-weight: bold;
      font-size: 11px;
      text-shadow: 0 1px 2px white;
    }

    .highlight {
      animation: pulse 0.4s ease-in-out 4;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.4); }
      100% { transform: scale(1); }
    }
    /* === Marker Petugas (LIVE GPS) === */
    .petugas-marker {
      width: 38px;
      height: 38px;
      background: #2563eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 14px rgba(37,99,235,0.6);
      border: 2px solid white;
    }

    .petugas-marker img {
      width: 22px;
      height: 22px;
    }

    /* === UI Compact Mode === */

    .small-input {
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
    }

    .small-btn {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 10px;
    }

    .ui-header b {
      font-size: 15px;
    }

    .status {
      font-size: 13px;
    }

    #uiBar {
      max-width: 280px;
    }

    #downloadBtn {
      background: #1f2937;
    }

    #zoomBtn {
      background: #0f766e;
    }

    #historyToggleBtn {
      background: #374151;
    }
    
    .close-history {
      position: absolute;
      top: 6px;
      right: 8px;
      border: none;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 16px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
    }

    .close-history:hover {
      background: rgba(0,0,0,0.85);
    }

    


  </style>
</head>

<body>

<div class="ui-bar" id="uiBar">

  <!-- HEADER (tidak pernah hilang) -->
  <div class="ui-header">
    <b>üìç OyonID Map</b>
    <button id="toggleBtn">‚ûñ</button>
  </div>

  <!-- KONTEN (yang boleh di-hide) -->
  <div id="uiContent">

    <input type="file" id="upload" accept=".xlsx,.xls" style="display:none;" />
    <button class="ui-btn small-btn" onclick="document.getElementById('upload').click()">
      üìÇ Upload Excel
    </button>

    <div id="fileNameLabel" style="font-size:12px;color:#555;"></div>

    <div id="statusText"></div>

  
    <button id="zoomBtn" class="ui-btn ui-secondary small-btn" style="display:none;">
      üîç Zoom Area Tagging
    </button>

    <div style="display:flex; gap:6px; width:100%;">
      <input id="searchInput" class="ui-input small-input" placeholder="4 digit IDPEL / Meter" />
      <button id="searchBtn" class="ui-btn small-btn">Cari</button>
    </div>

    <!-- <label>
      <input type="checkbox" id="filterDIJ" checked onchange="applyMarkerFilter()">
      Marker DIJ
    </label>

    <label>
      <input type="checkbox" id="filterTH" checked onchange="applyMarkerFilter()">
      Marker Tahun Lalu
    </label> -->

    <label style="display:flex;align-items:center;gap:6px;margin-top:8px;">
      <input type="checkbox" onchange="toggleRoute(this)">
      Ikuti kompas
    </label>

    <!-- FILTER DIJ & TH (SEJAJAR DI ATAS) -->
      <div class="row filter-row">
        <label class="chk">
          <input type="checkbox" id="chkDIJ" checked onchange="applyHariBacaFilter()">
          Lokasi DIJ
        </label>

        <label class="chk">
          <input type="checkbox" id="chkTH" checked onchange="applyHariBacaFilter()">
          Tahun Lalu
        </label>
      </div>

      <!-- FILTER 1 HARI BACA -->
      <label class="chk">
        <input type="checkbox" id="oneDayCheck">
        1 Hari Baca
      </label>

      <div class="hari-row">
        <button onclick="prevHari()">‚óÄ</button>
        <b id="hariBacaLabel">HARI: SEMUA</b>
        <button onclick="nextHari()">‚ñ∂</button>
      </div>

  <hr>
      <button id="historyToggleBtn" class="ui-btn">
      üìã Riwayat
    </button>
      
    <button id="downloadBtn" class="ui-btn small-btn">
      Finish & Download
    </button>
    
  </div>
</div>

<div id="historyPanel" style="display:none;">
  <button class="close-history" onclick="closeHistory()">‚úï</button>
  <div style="font-weight:bold;margin-bottom:6px;">üìã Riwayat Dibaca</div>
  <div id="historyList"></div>
</div>

<div id="floatingControls">
  <button id="fullMapBtn" class="float-btn">
    üó∫Ô∏è Full Map
  </button>
</div>


<div id="map"></div>
<div id="detailPanel" class="detail-panel">
  <div style="display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px;">

  <!-- Kiri -->
  <b>Detail Pelanggan</b>

  <!-- Tengah -->
  <label style="display:flex; justify-content:center; align-items:center; gap:6px; font-size:14px; font-weight:600;">
    <input type="checkbox" onchange="toggleCompare(this)">
    Bandingkan
  </label>

  <!-- Kanan -->
  <button onclick="closeDetail()" style="
    background:#eee;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    font-size:16px;
    cursor:pointer;
  ">‚ùå</button>

</div>

  <div id="detailSplit" style="display:flex; gap:12px; margin-top:10px;">
    <div id="detailLeft" style="flex:1; border:1px solid #eee; padding:10px; border-radius:12px;"></div>
    <div id="detailRight" style="flex:1; border:1px solid #eee; padding:10px; border-radius:12px;"></div>
  </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
  window.onerror = function (msg, src, line, col, err) {
  alert("JS ERROR:\n" + msg + "\nLine: " + line);
  console.error(err);
};
/* ======================
   GLOBAL STATE
====================== */
let markers = [];
let searchIndex = [];
let userLatLng = null;
let routingControl = null;
let petugasMarker = null;
let history = JSON.parse(localStorage.getItem("oyon_history") || "[]");
let originalRows = [];
let workingRows = [];
let filterHariBacaAktif = false;
let daftarHariBaca = [];
let indexHariBaca = 0;
let showDIJ = true;
let showTH = true;
let isFullMap = false;
let hasSelectedCustomer = false;
let historyVisible = false;
let hiddenMarkers = [];
window.isCompareMode = false;
window.compareMarkers = [];


function renderMarker(m, map) {
  if (!m || !m.marker) return;

  const marker = m.marker;

  // kalau sudah ada di map, jangan di-add lagi
  if (map.hasLayer(marker)) return;

  marker.addTo(map);
}


const STORAGE_KEY = "RBM_WORKING_STATE";


// Reset history setiap hari
const today = new Date().toDateString();
const savedDate = localStorage.getItem("oyon_history_date");

function closeHistory() {
  const panel = document.getElementById("historyPanel");
  if (panel) {
    panel.style.display = "none";
  }
}

if (savedDate !== today) {
  history = [];
  localStorage.setItem("oyon_history", "[]");
  localStorage.setItem("oyon_history_date", today);
  renderHistory();

}

/* ======================
   DOM
====================== */
const upload = document.getElementById("upload");
const statusText = document.getElementById("statusText");
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");
const zoomBtn = document.getElementById("zoomBtn");
const downloadBtn = document.getElementById("downloadBtn");

/* ======================
   INIT MAP
====================== */
const map = L.map("map", {
  preferCanvas: true,
  rotate: true,
  zoomControl: false,
  touchRotate: true,
  rotateControl: true
}).setView([-7.974155,112.6181065], 12);

function addMarkerToMap(marker) {
  if (!marker) return;
  if (typeof marker.addTo !== "function") return;
  if (!map.hasLayer(marker)) {
    marker.addTo(map);
  }
}

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 21
}).addTo(map);



/* ======================
   IKUT KOMPAS
====================== */
let lastBearing = null;
let lastUpdate = 0;
let compassHandler = null;

function enableCompass() {
  if (compassHandler) return; // sudah aktif

  compassHandler = (event) => {
    const now = Date.now();
    if (now - lastUpdate < 120) return;
    if (event.alpha == null) return;

    const target = 360 - event.alpha;
    if (lastBearing == null) lastBearing = target;

    const smooth = lastBearing + (target - lastBearing) * 0.25;
    map.setBearing(smooth);

    lastBearing = smooth;
    lastUpdate = now;
  };

  window.addEventListener("deviceorientation", compassHandler);
  showToast("üß≠ Kompas aktif");
}

function disableCompass() {
  if (compassHandler) {
    window.removeEventListener("deviceorientation", compassHandler);
    compassHandler = null;
    showToast("üõë Kompas mati");
  }
}

/* ======================
   LOAD EXCEL
====================== */
upload.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  // SIMPAN nama file
  localStorage.setItem("RBM_FILENAME", file.name);

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    originalRows = XLSX.utils.sheet_to_json(sheet);
    
    workingRows = structuredClone(originalRows);
    saveState();

    buildMarkers();
    renderHistory();

    

    if (statusText) {
      statusText.innerText = "‚úÖ Peta berhasil dibuat";
    }
    zoomBtn.style.display = "block";

    // auto zoom setelah upload
    zoomToAllMarkers();
  };
  reader.readAsArrayBuffer(file);

  document.addEventListener("DOMContentLoaded", () => {
  const statusText = document.getElementById("statusText");
});

};


/* ======================
   KUMPULKAN HARI BACA
====================== */
hariBacaList = [...new Set(
  workingRows
    .map(r => String(r["HARI BACA ACMT"]).trim())
    .filter(v => v !== "")
)].sort((a,b)=>a-b);

/* ======================
   SAAT LOAD
====================== */
window.addEventListener("load", () => {

  // Restore filename
  const savedFilename = localStorage.getItem("RBM_FILENAME");
  if (savedFilename) {
    document.getElementById("fileNameLabel").innerText = "üìÑ " + savedFilename;
  }

  const saved = localStorage.getItem(STORAGE_KEY);

  if (saved) {
    workingRows = JSON.parse(saved);

    map.whenReady(() => {
      buildMarkers();
      renderHistory();

      // Tampilkan tombol zoom
      if (workingRows.length > 0) {
        zoomBtn.style.display = "block";
      }

      // Auto zoom ke marker
      zoomToAllMarkers();
    });
  }
});

function zoomToAllMarkers() {
  if (!markers.length) return;
  const group = L.featureGroup(markers.map(m => m.marker));
  map.fitBounds(group.getBounds(), { padding: [40, 40] });
}
/* ======================
   FUNGSI FILTER MARKER HARI BACA
====================== */
function applyHariBacaFilter() {

  const showDIJ = document.getElementById("chkDIJ")?.checked ?? true;
  const showTH  = document.getElementById("chkTH")?.checked ?? true;

  markers.forEach(m => {

    let visible = true;

    // filter jenis marker
    if (m.type === "DIJ" && !showDIJ) visible = false;
    if (m.type === "TH"  && !showTH)  visible = false;

    // filter 1 hari baca
    if (filterHariBacaAktif) {
      const hari = (m.row["HARI BACA ACMT"] || "").toUpperCase();
      if (hari !== daftarHariBaca[indexHariBaca]) {
        visible = false;
      }
    }

    if (visible) {
      if (!map.hasLayer(m.marker)) m.marker.addTo(map);
    } else {
      if (map.hasLayer(m.marker)) map.removeLayer(m.marker);
    }
  });

  document.getElementById("hariBacaLabel").innerText =
    filterHariBacaAktif
      ? `HARI: ${daftarHariBaca[indexHariBaca]}`
      : "HARI: ALL";
}

function showNormalMarkers() {
  markers.forEach(m => {
    if (!map.hasLayer(m.marker)) {
      addMarkerToMap(m.marker);
    }
  });
}



/* ======================
   SIMPAN STATE
====================== */
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(workingRows));
}
/* ======================
   TAMPILKAN marker dij/tahun lalu saja
====================== */
function applyMarkerFilter() {}
/* ======================
function applyHariBacaFilter() {
  if (!filterHariBacaAktif) {
    applyMarkerFilter();
    return;
  }

  const hariAktif = daftarHariBaca[indexHariBaca];

  markers.forEach(m => {
    const hariRow = (m.row["HARI BACA ACMT"] || "").toUpperCase();

    if (hariRow === hariAktif) {
      addMarkerToMap(m.marker);
    } else {
      if (map.hasLayer(m.marker)) {
        map.removeLayer(m.marker);
      }
    }
  });

  updateHariBacaLabel();
}
  ====================== */

function nextHari(){
  if (!filterHariBacaAktif) return;
  if (!daftarHariBaca.length) return;

  indexHariBaca++;

  if (indexHariBaca >= daftarHariBaca.length) {
    indexHariBaca = 0;
  }

  applyHariBacaFilter();
}

function prevHari(){
  if (!filterHariBacaAktif) return;
  if (!daftarHariBaca.length) return;

  indexHariBaca--;

  if (indexHariBaca < 0) {
    indexHariBaca = daftarHariBaca.length - 1;
  }

  applyHariBacaFilter();
}


function updateHariBacaLabel() {
  const el = document.getElementById("hariBacaLabel");
  if (!el) return;

  el.innerText = filterHariBacaAktif
    ? `HARI: ${daftarHariBaca[indexHariBaca]}`
    : "HARI: ALL";
}

window.addEventListener("DOMContentLoaded", () => {
  const cb = document.getElementById("oneDayCheck");
  if (!cb) return;

  cb.onchange = e => {
    filterHariBacaAktif = e.target.checked;

    if (filterHariBacaAktif && daftarHariBaca.length === 0) {
      showToast("‚ö†Ô∏è Data hari baca kosong");
      cb.checked = false;
      filterHariBacaAktif = false;
      return;
    }

    applyHariBacaFilter();
  };
});


/* ======================
   TAMPILKAN NAMA FILE SAAT REFRESH
====================== */

// üîÅ sinkronkan filter hari baca dengan data yang di-undo
const hariUndo = (item.row["HARI BACA ACMT"] || "").toUpperCase();

const idx = daftarHariBaca.indexOf(hariUndo);
if (idx !== -1) {
  filterHariBacaAktif = true;
  indexHariBaca = idx;
}
/* ======================
   BUILD MARKERS
====================== */
function buildMarkers(){
  // üî• HAPUS SEMUA MARKER LAMA DARI MAP
markers.forEach(m => {
  if (map.hasLayer(m.marker)) {
    map.removeLayer(m.marker);
    }
  });

  markers = [];
  searchIndex = [];

  workingRows.forEach(row => {
    // ==========================
    // MARKER 1 ‚Äî LOKASI DIJ
    // ==========================
    const lat = parseFloat(row.LAT);
    const lng = parseFloat(row.LON);

    if(lat && lng){
      const color = getColor(row["HARI BACA ACMT"]);

      const iconDIJ = L.divIcon({
        html: `<div class="custom-marker" style="background:${color}"></div>`,
        iconSize: [16,16],
        iconAnchor: [8,16],
        className: ""
      });

      const markerDIJ = L.marker([lat, lng], { icon: iconDIJ });

      markerDIJ.bindTooltip(row.NAMA, {
        permanent: false,
        direction: "top",
        offset: [0, -10],
        opacity: 0.9,
        className: "marker-label"
      });

      markerDIJ.on("click", () => openDetail(row));

      markers.push({
        marker: markerDIJ,
        row: row,
        type: "DIJ"
      });

            searchIndex.push({
        idpel: String(row.IDPEL||"").replace(/\D/g,""),
        meter: String(row["NOMOR METER"]||"").replace(/\D/g,""),
        marker: markerDIJ,
        row
      });
      
    }
    

    // ==========================
// MARKER 2 ‚Äî TAGGING TAHUN LALU (HITAM)
// ==========================
const latTH = parseFloat(row.LATTH);
const lonTH = parseFloat(row.LONTH);

const hasTHLocation =
  latTH && lonTH &&
  !isNaN(latTH) &&
  !isNaN(lonTH);

if (hasTHLocation) {

  // ICON TAHUN LALU (WAJIB DULU)
  const iconTH = L.divIcon({
    html: `<div class="custom-marker" style="background:#000"></div>`,
    iconSize: [12, 12],
    iconAnchor: [6, 12],
    className: ""
  });

  // MARKER TAHUN LALU
  const markerTH = L.marker([latTH, lonTH], { icon: iconTH });

  markerTH.bindTooltip(
    `<b>${row.NAMA}</b><br>IDPEL: ${row.IDPEL}`,
    {
      permanent: false,
      direction: "top",
      offset: [0, -10],
      opacity: 0.8,
      className: "marker-label"
    }
  );

  markerTH.on("click", () => openDetail(row));

  markers.push({
    marker: markerTH,
    row,
    type: "TH"
  });
}
// ===== KUMPULKAN HARI BACA UNIK =====
daftarHariBaca = [...new Set(
  workingRows
    .map(r => (r["HARI BACA ACMT"] || "").toUpperCase())
    .filter(v => v)
)].sort();

indexHariBaca = 0;
updateHariBacaLabel();

  }); // ‚Üê TUTUP workingRows.forEach
}     // ‚Üê TUTUP function buildMarkers
applyHariBacaFilter();
markers.forEach(m => m.marker.addTo(map));
/* ======================
markers.forEach(m => {
  if (m.marker && m.marker.addTo) {
    m.marker.addTo(map);
  }
});====================== */

/* ======================
   HIGHLIGHT MARKER
====================== */
function highlightMarker(marker){
  const el = marker.getElement();
  if(!el) return;

  el.classList.add("highlight");

  setTimeout(() => {
    el.classList.remove("highlight");
  }, 1500);
}

function showLabel(marker) {
  marker.openTooltip();

  setTimeout(() => {
    marker.closeTooltip();
  }, 4000); // nama tampil 4 detik lalu hilang otomatis
}


function toggleRoute(cb) {
  if (cb.checked) {
    enableCompass();
    showToast("üß≠ Ikuti kompas aktif");
  } else {
    disableCompass();
    showToast("üõë Ikuti kompas mati");
  }
}

/* ======================
   SEARCH
====================== */
searchBtn.onclick = () => {
  const key = searchInput.value.trim();
  if(key.length < 4) {
    showToast("Masukkan minimal 4 digit");
    return;
  }

  const found = searchIndex.find(o =>
    o.idpel.endsWith(key) || o.meter.endsWith(key)
  );

  if(!found) {
    showToast("Tidak ditemukan");
    return;
  }

  if (searchIndex.length === 0) {
  showToast("Data belum siap, upload dulu");
  return;
  }

  addMarkerToMap(found.marker);

  map.setView(found.marker.getLatLng(), 19, { animate: true });

  highlightMarker(found.marker);
  showLabel(found.marker);
  openDetail(found.row);

  document.getElementById("toggleBtn").innerText = "‚ûï";
};


/* ======================
   ZOOM ALL
====================== */
zoomBtn.onclick = () => {
  const active = markers
    .map(m => m.marker)
    .filter(m => map.hasLayer(m));

  if (!active.length) {
    showToast("Tidak ada marker aktif");
    return;
  }

  const group = L.featureGroup(active);
  map.fitBounds(group.getBounds(), { padding: [40,40] });
};

/* ======================
   DETAIL PANEL
====================== */
function openDetail(r){
  hasSelectedCustomer = true;
  const panel = document.getElementById("detailPanel");
  const left = document.getElementById("detailLeft");
  const right = document.getElementById("detailRight");

  // simpan IDPEL yang sedang dibuka (global state kecil)
  window.currentCompareIDPEL = r.IDPEL;
  
  const cardHTML = (label, lat, lon, isTH = false) => `
  <div class="${isTH ? "card-th" : ""}">
    <div style="font-size:13px;color:${isTH ? "#9ca3af" : "#666"};margin-bottom:4px">
      ${label}
    </div>

    <h3 style="margin:4px 0">${r.NAMA}</h3>
    <div>üìü IDPEL: ${r.IDPEL}</div>
    <div>‚ö° DAYA: ${r.DAYA}</div>
    <div>üîß MERK: ${r["MERK METER"]}</div>
    <div>üî¢ NOMOR: ${r["NOMOR METER"]}</div>
    <div>üìÖ HARI BACA: ${r["HARI BACA ACMT"]}</div>

    <div style="margin-top:10px;display:flex;gap:6px;">
      ${
        (!isTH || (lat && lon))
          ? `<button class="btn-go" onclick="goTo(${lat},${lon})">üß≠ Tampil Rute</button>`
          : ``
      }
      <button class="btn-done" onclick="markDone('${r.IDPEL}')">‚úÖ Selesai</button>
    </div>
  </div>
`;

  // tampilkan compare hanya sekali di atas
  left.innerHTML = cardHTML(
    "üìç Lokasi DIJ",
    r.LAT,
    r.LON,
    false
  );

  right.innerHTML = cardHTML(
    "üìç Lokasi TAGGING TAHUN LALU",
    r.LATTH,
    r.LONTH,
    true
  );

    panel.classList.add("open");
  }


function closeDetail(){
  document.getElementById("detailPanel").classList.remove("open");
  hasSelectedCustomer = false;
}

function toggleFullMap() {
  const uiBar = document.getElementById("uiBar");
  const detailPanel = document.getElementById("detailPanel");
  const btn = document.getElementById("fullMapBtn");

  isFullMap = !isFullMap;

  if (isFullMap) {
    // üî• MASUK MODE FULL MAP
    if (uiBar) uiBar.style.display = "none";
    if (detailPanel) detailPanel.classList.remove("open");

    btn.innerText = "üìã SHOW MENU";
    showToast("üó∫Ô∏è Mode peta penuh");

  } else {
    // üî• KELUAR DARI FULL MAP
    if (uiBar) uiBar.style.display = "block";

    // hanya tampilkan bottom bar jika ada pelanggan aktif
    if (hasSelectedCustomer && detailPanel) {
      detailPanel.classList.add("open");
    }

    btn.innerText = "üó∫Ô∏è FULL MAP";
    showToast("üìç Mode normal");
  }
}


/* ======================



function toggleCompare(checkbox) {
  const idpel = window.currentCompareIDPEL;
  if (!idpel) return;

  if (checkbox.checked) {
    const active = [];

    // üî• hide semua marker
    markers.forEach(m => {
      if (map.hasLayer(m.marker)) {
        map.removeLayer(m.marker);
      }
    });

    // üî• tampilkan hanya marker pelanggan ini
    markers.forEach(m => {
      if (String(m.row.IDPEL) === String(idpel)) {
        addMarkerToMap(m.marker);
        active.push(m.marker);
      }
    });

    // zoom ke 2 marker
    if (active.length > 0) {
      const group = L.featureGroup(active);
      map.fitBounds(group.getBounds(), { padding: [60, 60] });
    }

    showToast("üîç Mode bandingkan aktif");
  } else {
    // üî• KEMBALIKAN SESUAI CHECKBOX
    applyHariBacaFilter();
    showToast("üìç Semua marker ditampilkan kembali");
  }
}
====================== */

/* ======================
   minimize menu saat bandingkan
====================== */

function toggleCompare(checkbox) {
  const idpel = String(window.currentCompareIDPEL || "");
  if (!idpel) return;

  const uiBar = document.getElementById("uiBar");
  const toggleBtn = document.getElementById("toggleBtn");

  if (checkbox.checked) {
    // =========================
    // MODE BANDINGKAN ON
    // =========================
    window.isCompareMode = true;

    // auto minimize menu
    if (uiBar && !uiBar.classList.contains("minimized")) {
      uiBar.classList.add("minimized");
      if (toggleBtn) toggleBtn.innerText = "‚ûï";
    }

    // sembunyikan semua marker
    markers.forEach(m => {
      if (map.hasLayer(m.marker)) {
        map.removeLayer(m.marker);
      }
    });

    // ambil 2 marker milik IDPEL aktif
    const activeMarkers = markers.filter(
      m => String(m.row.IDPEL) === idpel
    );

    // tampilkan hanya marker tsb
    activeMarkers.forEach(m => {
      m.marker.addTo(map);
    });

    // zoom ke 2 marker
    if (activeMarkers.length) {
      const group = L.featureGroup(activeMarkers.map(m => m.marker));
      map.fitBounds(group.getBounds(), { padding: [60, 60] });
    }

    showToast("üîç Mode bandingkan aktif");

  } else {
    exitCompareMode();
  }
}
function exitCompareMode() {
  window.isCompareMode = false;

  // bersihkan map
  markers.forEach(m => {
    if (map.hasLayer(m.marker)) {
      map.removeLayer(m.marker);
    }
  });

  // tampilkan kembali marker SESUAI FILTER
  applyHariBacaFilter();

  // restore menu
  const uiBar = document.getElementById("uiBar");
  const toggleBtn = document.getElementById("toggleBtn");

  if (uiBar && uiBar.classList.contains("minimized")) {
    uiBar.classList.remove("minimized");
    if (toggleBtn) toggleBtn.innerText = "‚ûñ";
  }

  showToast("üìç Mode bandingkan selesai");
}


function onFinishCompare() {
  const checkbox = document.getElementById("compareCheckbox");
  if (checkbox) checkbox.checked = false;

  exitCompareMode();
}


function minimizeMenu() {
  const panel = document.getElementById("uiContent");
  if (!panel) return;

  panel.classList.add("minimized");
}
    
/* ======================
   ROUTING
====================== */
function goTo(lat,lng){
  if(!userLatLng) return alert("GPS belum aktif");

  if(routingControl) map.removeControl(routingControl);

      routingControl = L.Routing.control({
      waypoints: [L.latLng(userLatLng), L.latLng(lat,lng)],
      addWaypoints: false,
      draggableWaypoints: false,
      createMarker: () => null
    }).addTo(map);


  document.getElementById("cancelRouteBtn").style.display="block";
}
  

function cancelRoute(){
  if(routingControl) map.removeControl(routingControl);
  routingControl = null;
  document.getElementById("cancelRouteBtn").style.display="none";
}

/* ======================
   DONE + HISTORY
====================== */
function markDone(idpel){

  if (window.isCompareMode) {
  const cb = document.querySelector('#detailPanel input[type="checkbox"]');
  if (cb) cb.checked = false;
  exitCompareMode();
}


  idpel = String(idpel);

  // 1Ô∏è‚É£ ambil data pelanggan
  const found = workingRows.find(r => String(r.IDPEL) === idpel);
  if (!found) return;

  // 2Ô∏è‚É£ simpan ke history
  history.push({
    row: found,
    time: new Date().toLocaleTimeString("id-ID")
  });
  localStorage.setItem("oyon_history", JSON.stringify(history));

  // 3Ô∏è‚É£ hapus dari workingRows
  workingRows = workingRows.filter(r => String(r.IDPEL) !== idpel);
  saveState();

  // 4Ô∏è‚É£ HAPUS MARKER DIJ + TH DENGAN IDPEL YANG SAMA
  markers = markers.filter(obj => {
    if (String(obj.row.IDPEL) === idpel) {
      if (map.hasLayer(obj.marker)) {
        map.removeLayer(obj.marker);
      }
      return false; // buang dari array
    }
    return true;
  });

  // 5Ô∏è‚É£ update UI
  renderHistory();
  closeDetail();

  showToast("‚úÖ Pelanggan ditandai selesai");
}

/* ======================
   DONE + HISTORY
====================== */
function renderHistory() {
  const el = document.getElementById("historyList");
  if (!el) return;

  if (!history || history.length === 0) {
    el.innerHTML = `
      <div style="padding:10px;color:#666;text-align:center">
        üì≠ Belum ada pelanggan selesai hari ini
      </div>`;
    return;
  }

  el.innerHTML = history.map((item, index) => `
    <div style="border-bottom:1px solid #eee;padding:8px;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <strong>${item.row.NAMA}</strong><br>
        IDPEL: ${item.row.IDPEL}<br>
        <small>${item.time}</small>
      </div>
      <button onclick="undoHistory(${index})"
        style="background:#2563eb;color:white;border:none;padding:6px 10px;border-radius:8px;font-size:12px;">
        Undo
      </button>
    </div>
  `).join("");
}


function undoHistory(index) {
  const item = history[index];   // ‚¨ÖÔ∏è WAJIB ADA & DI ATAS
  if (!item) return;

  // keluar dari mode bandingkan jika aktif
  if (window.isCompareMode) {
    const cb = document.getElementById("compareCheckbox");
    if (cb) cb.checked = false;
    exitCompareMode();
  }

  // üîÅ sinkronkan filter hari baca dengan data yang di-undo
  const hariUndo = (item.row["HARI BACA ACMT"] || "").toUpperCase();
  const idx = daftarHariBaca.indexOf(hariUndo);
  if (idx !== -1) {
    filterHariBacaAktif = true;
    indexHariBaca = idx;
  }

  // kembalikan data ke peta
  workingRows.push(item.row);
  saveState();

  // hapus dari history
  history.splice(index, 1);
  localStorage.setItem("oyon_history", JSON.stringify(history));

  // rebuild & tampilkan marker
  buildMarkers();
  applyHariBacaFilter();

  renderHistory();
  showToast(`‚Ü©Ô∏è Dikembalikan ke HARI BACA ${hariUndo}`);
}




/* ======================
   TAMPILAN KEMBALI KE AREA TAGGING
====================== */

function saveMapView() {
  const center = map.getCenter();
  const zoom = map.getZoom();

  localStorage.setItem("RBM_MAP_VIEW", JSON.stringify({
    lat: center.lat,
    lng: center.lng,
    zoom: zoom
  }));
}

function restoreMapView() {
  const savedView = localStorage.getItem("RBM_MAP_VIEW");

  if (savedView) {
    const view = JSON.parse(savedView);
    map.setView([view.lat, view.lng], view.zoom);
  } else {
    zoomToAllMarkers(); // fallback
  }
}


/* ======================
   reset history 23.00
====================== */




/* ======================
   TOAST
====================== */
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerHTML = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),5000);
}
/* ======================
   FINISH DAN SIMPAN RBM UPDATE
====================== */
downloadBtn.onclick = () => {
  if (workingRows.length === 0) {
    showToast("‚ö†Ô∏è Tidak ada data untuk diunduh");
    return;
  }

  // Ambil KODE PETUGAS dari baris pertama
  const kodePetugas = (workingRows[0]["KODE PETUGAS"] || "UNKNOWN")
    .toString()
    .replace(/\s+/g, "_");

  // Buat timestamp
  const now = new Date();
  const dd = String(now.getDate()).padStart(2, "0");
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const hh = String(now.getHours()).padStart(2, "0");
  const min = String(now.getMinutes()).padStart(2, "0");

  const filename = `RBM_${kodePetugas}_${dd}-${mm}_${hh}-${min}.xlsx`;

  // Generate Excel
  const ws = XLSX.utils.json_to_sheet(workingRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "RBM Update");

  XLSX.writeFile(wb, filename);

  showToast(`‚úÖ RBM berhasil diunduh<br><b>${filename}</b><br>Selamat beristirahat, wahai pejuang nafkah.<br>Semoga setiap lelahmu bernilai ibadah.`);
};


/* ======================
   GPS
====================== */
navigator.geolocation?.watchPosition(pos => {
  userLatLng = [pos.coords.latitude, pos.coords.longitude];

  const icon = L.divIcon({
    html: `
      <div class="petugas-marker">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" />
      </div>
    `,
    iconSize: [38,38],
    iconAnchor: [19,19],
    className: ""
  });

  if (!petugasMarker) {
    petugasMarker = L.marker(userLatLng, { icon }).addTo(map);
    petugasMarker.bindTooltip("üìç Lokasi Anda", {
      permanent: false,
      direction: "top"
    });
  } else {
    petugasMarker.setLatLng(userLatLng);
  }

}, err => {
  console.warn("GPS error:", err);
}, {
  enableHighAccuracy: true,
  maximumAge: 1000,
  timeout: 10000
});

/* ======================
   COLOR MAP
====================== */
function getColor(v){
  const map={
    A:"#22c55e",B:"#f97316",C:"#3b82f6",D:"#ef4444",
    E:"#a855f7",F:"#14b8a6",G:"#eab308",H:"#ec4899",
    I:"#6366f1",J:"#84cc16",K:"#06b6d4",L:"#f43f5e",
    M:"#7c3aed",N:"#f59e0b",O:"#0ea5e9",P:"#10b981"
  };
  return map[(v||"").toUpperCase()] || "#64748b";
}

renderHistory();
window.addEventListener("DOMContentLoaded", () => {

  function openHistory(){
  const panel = document.getElementById("historyPanel");
  panel.style.display = "block";
  renderHistory();
}

function closeHistory(){
  const panel = document.getElementById("historyPanel");
  panel.style.display = "none";
}

document.getElementById("historyToggleBtn").onclick = openHistory;


});
/* ======================
   minimize btn
====================== */
window.addEventListener("DOMContentLoaded", () => {
  const uiBar = document.getElementById("uiBar");
  const toggleBtn = document.getElementById("toggleBtn");

  toggleBtn.onclick = () => {
    uiBar.classList.toggle("minimized");
    toggleBtn.innerText = uiBar.classList.contains("minimized") ? "‚ûï" : "‚ûñ";
  };

  document.getElementById("fullMapBtn").onclick = toggleFullMap;
});

</script>


<button id="cancelRouteBtn" onclick="cancelRoute()" style="display:none;">
  ‚ùå TUTUP RUTE
</button>

<div id="toast" class="toast"></div>

</body>
</html>
