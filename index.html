<!DOCTYPE html>
<html>
<head>
  <title>OyonID Map</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
    }

    #upload {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: none;
    }

    .ui-bar {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      z-index: 999;
    }

    .ui-input {
      padding: 14px;
      font-size: 17px;
      border-radius: 12px;
      border: 1px solid #ccc;
    }

    .ui-btn {
      padding: 14px;
      font-size: 17px;
      border-radius: 14px;
      background: #2563eb;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    .ui-secondary {
      background: #059669;
    }

    .ui-btn:hover {
      opacity: 0.9;
    }

    #map {
      padding-bottom: 120px;
      height: 100vh;
      width: 100%;
    }

    .ui-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 320px;
      border-radius: 16px;
    }

        .status {
      font-weight: bold;
    }

        .ui-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

      #toggleBtn {
      background: black;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 16px;
      cursor: pointer;
    }
        #cancelRouteBtn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 22px;
      font-size: 16px;
      border-radius: 30px;
      background: #dc2626;
      color: white;
      font-weight: bold;
      border: none;
      z-index: 9999;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

      .ui-bar.minimized #uiContent {
      display: none;
    }


    #historyToggleBtn {
      position: fixed;
      bottom: 90px;
      right: 20px;
      z-index: 9999;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: #111827;
      color: white;
      font-weight: bold;
    }

      #historyPanel {
      position: fixed;
      top: 70px;
      right: 20px;
      width: 280px;
      max-height: 60vh;
      overflow-y: auto;
      background: white;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,.3);
      z-index: 9998;
      font-size: 14px;
    }

      .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #111827;
      color: #fff;
      padding: 16px 22px;
      border-radius: 16px;
      font-size: 15px;
      max-width: 90%;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s ease;
      z-index: 99999;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }

      .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
        /* === Modern Marker Teardrop === */
      .custom-marker {
      width: 22px;
      height: 22px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 1.5px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
      position: relative;
    }

    .custom-marker::after {
      content: "";
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 7px;
      left: 7px;
    }

    .popup-card {
      font-size: 14px;
      line-height: 1.5;
      min-width: 220px;
    }

    .popup-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .popup-row {
      margin-bottom: 2px;
    }

    .popup-actions {
      margin-top: 10px;
      display: flex;
      gap: 6px;
    }

    .btn-go {
      flex: 1;
      background: #2dd4bf;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 10px;
    }

    .btn-done {
      flex: 1;
      background: #fb7185;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 10px;
    }

    .detail-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 26vh;
      background: white;
      z-index: 9999;
      transform: translateY(100%);
      transition: 0.3s ease;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -10px 25px rgba(0,0,0,0.2);
      padding: 16px;
      overflow-y: auto;
      #detailSplit {
      flex-direction: row;
    }

    @media (max-width: 600px) {
      #detailSplit {
        flex-direction: column;
      }
    }
    }

    .detail-panel.open {
      transform: translateY(0);
    }


    .leaflet-routing-container {
      display: none !important;
    }

    #sidebar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 22vh;   /* sebelumnya kemungkinan 60‚Äì80vh */
    background: #fff;
    border-top: 1px solid #ddd;
    border-radius: 16px 16px 0 0;
    overflow-y: auto;
    transition: transform 0.3s ease;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
    font-size: 14px;
    }

    #sidebar {
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.95);
    }


    .highlight-marker {
    animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }

    .marker-label {
      background: transparent;
      border: none;
      color: #111;
      font-weight: bold;
      font-size: 11px;
      text-shadow: 0 1px 2px white;
    }

    .highlight {
      animation: pulse 0.4s ease-in-out 4;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.4); }
      100% { transform: scale(1); }
    }
    /* === Marker Petugas (LIVE GPS) === */
    .petugas-marker {
      width: 38px;
      height: 38px;
      background: #2563eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 14px rgba(37,99,235,0.6);
      border: 2px solid white;
    }

    .petugas-marker img {
      width: 22px;
      height: 22px;
    }


  </style>
</head>

<body>

<div class="ui-bar" id="uiBar">

  <!-- HEADER (tidak pernah hilang) -->
  <div class="ui-header">
    <b>üìç OyonID Map</b>
    <button id="toggleBtn">‚ûñ</button>
  </div>

  <!-- KONTEN (yang boleh di-hide) -->
  <div id="uiContent">

    <input type="file" id="upload" accept=".xlsx,.xls" />
    <div id="fileNameLabel" style="font-size:13px;color:#444;"></div>
    <div id="statusText" class="status"></div>

    <input id="searchInput" class="ui-input" placeholder="Masukkan 4 digit IDPEL / Meter" />
    <button id="searchBtn" class="ui-btn">CARI</button>

    <button id="zoomBtn" class="ui-btn ui-secondary" style="display:none;">Zoom Lokasi Tagging</button>
    <button id="downloadBtn" class="ui-btn">FINISH & Download RBM Update</button>

  </div>
</div>

<div id="historyPanel" style="display:none;">
  <div style="font-weight:bold;margin-bottom:6px;">üìã Riwayat Dibaca</div>
  <div id="historyList"></div>
</div>

<button id="historyToggleBtn">üìã Riwayat</button>

<div id="map"></div>
<div id="detailPanel" class="detail-panel">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <b>Detail Pelanggan</b>
    <button onclick="closeDetail()">‚ùå</button>
  </div>

  <div id="detailSplit" style="display:flex; gap:12px; margin-top:10px;">
    <div id="detailLeft" style="flex:1; border:1px solid #eee; padding:10px; border-radius:12px;"></div>
    <div id="detailRight" style="flex:1; border:1px solid #eee; padding:10px; border-radius:12px;"></div>
  </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* ======================
   GLOBAL STATE
====================== */
let map;
let markers = [];
let searchIndex = [];
let userLatLng = null;
let routingControl = null;
let petugasMarker = null;
let history = JSON.parse(localStorage.getItem("oyon_history") || "[]");
let originalRows = [];
let workingRows = [];

const STORAGE_KEY = "RBM_WORKING_STATE";


// Reset history setiap hari
const today = new Date().toDateString();
const savedDate = localStorage.getItem("oyon_history_date");

if (savedDate !== today) {
  history = [];
  localStorage.setItem("oyon_history", "[]");
  localStorage.setItem("oyon_history_date", today);
  localStorage.removeItem("oyon_history");
  renderHistory();

}

/* ======================
   DOM
====================== */
const upload = document.getElementById("upload");
const statusText = document.getElementById("statusText");
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");
const zoomBtn = document.getElementById("zoomBtn");
const downloadBtn = document.getElementById("downloadBtn");

/* ======================
   INIT MAP
====================== */
map = L.map("map").setView([-6.2,106.8], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* ======================
   LOAD EXCEL
====================== */
upload.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  // SIMPAN nama file
  localStorage.setItem("RBM_FILENAME", file.name);

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    originalRows = XLSX.utils.sheet_to_json(sheet);

    localStorage.removeItem(STORAGE_KEY);
    workingRows = structuredClone(originalRows);
    saveState();

    buildMarkers();
    renderHistory();

    statusText.innerText = "‚úÖ Peta berhasil dibuat";
    zoomBtn.style.display = "block";

    // auto zoom setelah upload
    zoomToAllMarkers();
  };
  reader.readAsArrayBuffer(file);
};

/* ======================
   SAAT LOAD
====================== */
window.addEventListener("load", () => {

  // Restore filename
  const savedFilename = localStorage.getItem("RBM_FILENAME");
  if (savedFilename) {
    document.getElementById("fileNameLabel").innerText = "üìÑ " + savedFilename;
  }

  const saved = localStorage.getItem(STORAGE_KEY);

  if (saved) {
    workingRows = JSON.parse(saved);

    map.whenReady(() => {
      buildMarkers();
      renderHistory();

      // Tampilkan tombol zoom
      if (workingRows.length > 0) {
        zoomBtn.style.display = "block";
      }

      // Auto zoom ke marker
      zoomToAllMarkers();
    });
  }
});

function zoomToAllMarkers() {
  if (!markers.length) return;
  const group = L.featureGroup(markers.map(m => m.marker));
  map.fitBounds(group.getBounds(), { padding: [40, 40] });
}

/* ======================
   SIMPAN STATE
====================== */
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(workingRows));
}
/* ======================
   TAMPILKAN NAMA FILE SAAT REFRESH
====================== */
fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];

  if (!file) return;

  localStorage.setItem("RBM_FILENAME", file.name);

  handleExcel(file); // fungsi lama Anda
});

/* ======================
   BUILD MARKERS
====================== */
function buildMarkers(){
  markers.forEach(m => map.removeLayer(m.marker));
  markers = [];
  searchIndex = [];

  workingRows.forEach(row => {
    const lat = parseFloat(row.LAT);
    const lng = parseFloat(row.LON);
    if(!lat || !lng) return;

    const color = getColor(row["HARI BACA ACMT"]);

    const icon = L.divIcon({
      html: `<div class="custom-marker" style="background:${color}"></div>`,
      iconSize: [22,22],
      iconAnchor: [11,22],
      className: ""
    });

    const marker = L.marker([lat,lng], {icon}).addTo(map);
    marker.bindTooltip(row.NAMA, {
      permanent: false,
      direction: "top",
      offset: [0, -10],
      opacity: 0.9,
      className: "marker-label"
    });
  
    marker.on("click", () => openDetail(row));

    markers.push({marker,row});

    searchIndex.push({
      idpel: String(row.IDPEL||"").replace(/\D/g,""),
      meter: String(row["NOMOR METER"]||"").replace(/\D/g,""),
      marker,
      row
    });
  });
}

/* ======================
   HIGHLIGHT MARKER
====================== */

function highlightMarker(marker) {
  const el = marker.getElement();
  if (!el) return;

  el.classList.add("highlight");

  setTimeout(() => {
    el.classList.remove("highlight");
  }, 2000);
}

function showLabel(marker) {
  marker.openTooltip();

  setTimeout(() => {
    marker.closeTooltip();
  }, 4000); // nama tampil 4 detik lalu hilang otomatis
}


/* ======================
   SEARCH
====================== */
searchBtn.onclick = () => {
  const key = searchInput.value.trim();
  if(key.length < 4) return alert("Minimal 4 digit");

  const found = searchIndex.find(o =>
    o.idpel.endsWith(key) || o.meter.endsWith(key)
  );

  if(!found) return alert("Tidak ditemukan");

  map.setView(found.marker.getLatLng(), 19, { animate: true });

  highlightMarker(found.marker);
  showLabel(found.marker);
  openDetail(found.row);

  document.getElementById("uiBar").classList.add("minimized");
  document.getElementById("toggleBtn").innerText = "‚ûï";
};



function highlightMarker(marker){
  const el = marker.getElement();
  if(!el) return;

  el.classList.add("highlight");

  setTimeout(() => {
    el.classList.remove("highlight");
  }, 1500);
}


/* ======================
   ZOOM ALL
====================== */
zoomBtn.onclick = () => {
  if(!markers.length) return;
  const group = L.featureGroup(markers.map(m=>m.marker));
  map.fitBounds(group.getBounds(), {padding:[40,40]});
};

/* ======================
   DETAIL PANEL
====================== */
function openDetail(r){
  const panel = document.getElementById("detailPanel");
  const left = document.getElementById("detailLeft");
  const right = document.getElementById("detailRight");

  const cardHTML = (label) => `
    <div style="font-size:13px;color:#666;margin-bottom:4px">${label}</div>
    <h3 style="margin:4px 0">${r.NAMA}</h3>
    <div>üìü IDPEL: ${r.IDPEL}</div>
    <div>‚ö° DAYA: ${r.DAYA}</div>
    <div>üîß MERK: ${r["MERK METER"]}</div>
    <div>üî¢ NOMOR: ${r["NOMOR METER"]}</div>
    <div>üìÖ HARI BACA: ${r["HARI BACA ACMT"]}</div>

    <div style="margin-top:10px;display:flex;gap:6px;">
      <button class="btn-go" onclick="goTo(${r.LAT},${r.LON})">üß≠ Tampil Rute</button>
      <button class="btn-done" onclick="markDone('${r.IDPEL}')">‚úÖ Selesai</button>
    </div>
  `;

  left.innerHTML = cardHTML("üìç Lokasi DIJ");
  right.innerHTML = cardHTML("üìç Lokasi TAGGING TAHUN LALU");

  panel.classList.add("open");
}


function closeDetail(){
  document.getElementById("detailPanel").classList.remove("open");
}

/* ======================
   ROUTING
====================== */
function goTo(lat,lng){
  if(!userLatLng) return alert("GPS belum aktif");

  if(routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    waypoints: [L.latLng(userLatLng), L.latLng(lat,lng)],
    addWaypoints:false,
    draggableWaypoints:false,
    createMarker:()=>null
  }).addTo(map);

  document.getElementById("cancelRouteBtn").style.display="block";
}

function cancelRoute(){
  if(routingControl) map.removeControl(routingControl);
  routingControl = null;
  document.getElementById("cancelRouteBtn").style.display="none";
}

/* ======================
   DONE + HISTORY
====================== */
function markDone(idpel){
  const found = workingRows.find(r => String(r.IDPEL) === String(idpel));
  if (!found) return;

  history.push({
    row: found,
    time: new Date().toLocaleTimeString()
  });

  localStorage.setItem("oyon_history", JSON.stringify(history));

  workingRows = workingRows.filter(r => String(r.IDPEL) !== String(idpel));

  saveState();
  buildMarkers();
  renderHistory();
  closeDetail();

  showToast("‚úÖ Ditandai selesai");
}

/* ======================
   DONE + HISTORY
====================== */
function renderHistory() {
  const el = document.getElementById("historyList");
  if (!el) return;

  if (!history || history.length === 0) {
    el.innerHTML = `
      <div style="padding:10px;color:#666;text-align:center">
        üì≠ Belum ada pelanggan selesai hari ini
      </div>`;
    return;
  }

  el.innerHTML = history.map((item, index) => `
    <div style="border-bottom:1px solid #eee;padding:8px;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <strong>${item.row.NAMA}</strong><br>
        IDPEL: ${item.row.IDPEL}<br>
        <small>${item.time}</small>
      </div>
      <button onclick="undoHistory(${index})"
        style="background:#2563eb;color:white;border:none;padding:6px 10px;border-radius:8px;font-size:12px;">
        Undo
      </button>
    </div>
  `).join("");
}


function undoHistory(index){
  const item = history[index];
  if (!item) return;

  // kembalikan data ke peta
  workingRows.push(item.row);
saveState();


  // hapus dari history
  history.splice(index, 1);

  // simpan ulang
  localStorage.setItem("oyon_history", JSON.stringify(history));

  // rebuild map
  buildMarkers();
  renderHistory();

  showToast("‚Ü©Ô∏è Data dikembalikan ke peta");
}
/* ======================
   TAMPILAN KEMBALI KE AREA TAGGING
====================== */

function saveMapView() {
  const center = map.getCenter();
  const zoom = map.getZoom();

  localStorage.setItem("RBM_MAP_VIEW", JSON.stringify({
    lat: center.lat,
    lng: center.lng,
    zoom: zoom
  }));
}

function restoreMapView() {
  const savedView = localStorage.getItem("RBM_MAP_VIEW");

  if (savedView) {
    const view = JSON.parse(savedView);
    map.setView([view.lat, view.lng], view.zoom);
  } else {
    zoomToAllMarkers(); // fallback
  }
}


/* ======================
   reset history 23.00
====================== */




/* ======================
   TOAST
====================== */
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerHTML = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),5000);
}
/* ======================
   FINISH DAN SIMPAN RBM UPDATE
====================== */
downloadBtn.onclick = () => {
  if (workingRows.length === 0) {
    showToast("‚ö†Ô∏è Tidak ada data untuk diunduh");
    return;
  }

  // Ambil KODE PETUGAS dari baris pertama
  const kodePetugas = (workingRows[0]["KODE PETUGAS"] || "UNKNOWN")
    .toString()
    .replace(/\s+/g, "_");

  // Buat timestamp
  const now = new Date();
  const dd = String(now.getDate()).padStart(2, "0");
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const hh = String(now.getHours()).padStart(2, "0");
  const min = String(now.getMinutes()).padStart(2, "0");

  const filename = `RBM_${kodePetugas}_${dd}-${mm}_${hh}-${min}.xlsx`;

  // Generate Excel
  const ws = XLSX.utils.json_to_sheet(workingRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "RBM Update");

  XLSX.writeFile(wb, filename);

  showToast(`‚úÖ RBM berhasil diunduh<br><b>${filename}</b><br>Selamat beristirahat, wahai pejuang nafkah.<br>Semoga setiap lelahmu bernilai ibadah.`);
};


/* ======================
   GPS
====================== */
navigator.geolocation?.watchPosition(pos => {
  userLatLng = [pos.coords.latitude, pos.coords.longitude];

  const icon = L.divIcon({
    html: `
      <div class="petugas-marker">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" />
      </div>
    `,
    iconSize: [38,38],
    iconAnchor: [19,19],
    className: ""
  });

  if (!petugasMarker) {
    petugasMarker = L.marker(userLatLng, { icon }).addTo(map);
    petugasMarker.bindTooltip("üìç Lokasi Anda", {
      permanent: false,
      direction: "top"
    });
  } else {
    petugasMarker.setLatLng(userLatLng);
  }

}, err => {
  console.warn("GPS error:", err);
}, {
  enableHighAccuracy: true,
  maximumAge: 1000,
  timeout: 10000
});

/* ======================
   COLOR MAP
====================== */
function getColor(v){
  const map={
    A:"#22c55e",B:"#f97316",C:"#3b82f6",D:"#ef4444",
    E:"#a855f7",F:"#14b8a6",G:"#eab308",H:"#ec4899",
    I:"#6366f1",J:"#84cc16",K:"#06b6d4",L:"#f43f5e",
    M:"#7c3aed",N:"#f59e0b",O:"#0ea5e9",P:"#10b981"
  };
  return map[(v||"").toUpperCase()] || "#64748b";
}

renderHistory();
document.getElementById("historyToggleBtn").onclick = () => {
  const panel = document.getElementById("historyPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  renderHistory();
};
/* ======================
   minimize btn
====================== */
const uiBar = document.getElementById("uiBar");
const toggleBtn = document.getElementById("toggleBtn");

toggleBtn.onclick = () => {
  uiBar.classList.toggle("minimized");
};

</script>


<button id="cancelRouteBtn" onclick="cancelRoute()" style="display:none;">
  ‚ùå TUTUP RUTE
</button>

<div id="toast" class="toast"></div>

</body>
</html>
